# 📊 СХЕМА РАБОТЫ БОТА
## Raffle Tracker - Пошаговая визуализация

---

## 🔄 ОБЩАЯ СХЕМА РАБОТЫ

```
┌─────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                              │
│          (Видит розыгрыш в Telegram-канале)                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Пересылает сообщение
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  @raffletracker_bot                          │
│              (Получает текстовое сообщение)                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Анализирует
                         ▼
┌─────────────────────────────────────────────────────────────┐
│               ИИ-РАСПОЗНАВАТЕЛЬ                              │
│   • Ищет ключевые слова (розыгрыш, конкурс, приз)          │
│   • Извлекает дату и время                                  │
│   • Находит каналы (@username)                              │
│   • Определяет приз                                         │
│   • Вычисляет уверенность (0-100%)                          │
└────────────────────────┬────────────────────────────────────┘
                         │
           ┌─────────────┴─────────────┐
           │                           │
    Уверенность > 60%           Уверенность < 60%
           │                           │
           ▼                           ▼
    ┌─────────────┐            ┌──────────────┐
    │ РАСПОЗНАНО  │            │ НЕ РОЗЫГРЫШ  │
    └──────┬──────┘            └──────┬───────┘
           │                           │
           │                           │
           ▼                           ▼
┌─────────────────────┐       ┌────────────────┐
│  Показать кнопки:   │       │ "Не понимаю    │
│  ✅ Добавить        │       │  команду"      │
│  ❌ Отклонить       │       └────────────────┘
│  📝 Редактировать   │
└──────────┬──────────┘
           │
   Пользователь нажимает ✅
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│                  БАЗА ДАННЫХ                                 │
│  • Сохраняет розыгрыш                                       │
│  • Записывает каналы                                        │
│  • Создаёт напоминание                                      │
│  • Начинает отслеживание подписок                           │
└─────────────────────────────────────────────────────────────┘
           │
           │ Автоматически
           ▼
┌─────────────────────────────────────────────────────────────┐
│              СИСТЕМА НАПОМИНАНИЙ                             │
│  • За день до дедлайна: "⏰ Проверьте подписки!"           │
│  • После завершения: "🧹 Отписаться от каналов?"           │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 ДЕТАЛЬНЫЙ ПРОЦЕСС РАСПОЗНАВАНИЯ

```
ВХОДЯЩЕЕ СООБЩЕНИЕ
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 1: Предварительная проверка              │
│  • Проверка настроек пользователя             │
│  • Автопоиск включён? ────────────► НЕТ → СТОП│
│  • ДА ↓                                        │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 2: Анализ ключевых слов                  │
│  ┌─────────────────────────────────────────┐  │
│  │ Ищем слова:                             │  │
│  │ • "розыгрыш", "конкурс" = +30 баллов   │  │
│  │ • "приз", "выиграть" = +20 баллов      │  │
│  │ • "giveaway" = +30 баллов              │  │
│  │ • Эмодзи 🎉🎁 = +10 баллов каждый      │  │
│  └─────────────────────────────────────────┘  │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 3: Поиск даты и времени                  │
│  ┌─────────────────────────────────────────┐  │
│  │ Паттерны:                               │  │
│  │ • 20.10.2025                            │  │
│  │ • 20/10/2025                            │  │
│  │ • 20 октября                            │  │
│  │ • до 20.10                              │  │
│  │                                         │  │
│  │ Найдена дата? = +15 баллов             │  │
│  └─────────────────────────────────────────┘  │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 4: Поиск каналов                         │
│  ┌─────────────────────────────────────────┐  │
│  │ Паттерны:                               │  │
│  │ • @channel_name                         │  │
│  │ • t.me/channel_name                     │  │
│  │                                         │  │
│  │ Каждый канал = +10 баллов              │  │
│  └─────────────────────────────────────────┘  │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 5: Определение приза                     │
│  ┌─────────────────────────────────────────┐  │
│  │ Ключевые слова:                         │  │
│  │ • iPhone, MacBook, денег, рублей        │  │
│  │ • Ищем контекст вокруг слов             │  │
│  │                                         │  │
│  │ Приз найден = +20 баллов               │  │
│  └─────────────────────────────────────────┘  │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 6: Расчёт итоговой уверенности           │
│                                               │
│  Сумма баллов:                                │
│  • 0-40 баллов   → НЕ розыгрыш (0%)          │
│  • 41-60 баллов  → Возможно (50%)            │
│  • 61-80 баллов  → Вероятно (75%)            │
│  • 81-100 баллов → Точно розыгрыш (95%+)     │
│                                               │
│  Максимум = 100 баллов                        │
└───────┬───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│  ШАГ 7: Сравнение с минимальным порогом       │
│                                               │
│  Уверенность >= Минимум (60%) ?               │
│  ┌─────────────┬─────────────┐               │
│  │     ДА      │     НЕТ     │               │
│  │      ▼      │      ▼      │               │
│  │  РАСПОЗНАНО │  ОТКЛОНЕНО  │               │
│  └─────────────┴─────────────┘               │
└───────────────────────────────────────────────┘
```

---

## 🎮 ЖИЗНЕННЫЙ ЦИКЛ РОЗЫГРЫША

```
1. ДОБАВЛЕНИЕ
   ┌──────────────────────────┐
   │ Пользователь добавляет   │
   │ ✅ Добавить              │
   └────────┬─────────────────┘
            │
            ▼
   ┌──────────────────────────┐
   │ Сохранение в БД          │
   │ • ID розыгрыша           │
   │ • Название, приз         │
   │ • Дата/время             │
   │ • Список каналов         │
   │ • Статус: АКТИВНЫЙ       │
   └────────┬─────────────────┘
            │
            ▼

2. ОТСЛЕЖИВАНИЕ
   ┌──────────────────────────┐
   │ Начало отслеживания      │
   │ • Запись каналов в       │
   │   unsubscribe_tracking   │
   │ • Создание напоминаний   │
   └────────┬─────────────────┘
            │
            ▼
   ┌──────────────────────────┐
   │ Пользователь может:      │
   │ • Проверить подписки ✅  │
   │ • Редактировать ✏️       │
   │ • Удалить 🗑️            │
   └────────┬─────────────────┘
            │
            ▼

3. НАПОМИНАНИЕ (за 1 день)
   ┌──────────────────────────┐
   │ ⏰ Автоматическое        │
   │    напоминание           │
   │                          │
   │ "Завтра дедлайн!         │
   │  Проверьте подписки"     │
   └────────┬─────────────────┘
            │
            ▼

4. ЗАВЕРШЕНИЕ
   ┌──────────────────────────┐
   │ Дедлайн наступил         │
   │ Статус: ЗАВЕРШЁН         │
   └────────┬─────────────────┘
            │
            ▼
   ┌──────────────────────────┐
   │ 🧹 Напоминание отписаться│
   │ (через день после)       │
   └────────┬─────────────────┘
            │
            ▼

5. УПРАВЛЕНИЕ ПОДПИСКАМИ
   ┌──────────────────────────┐
   │ Пользователь отписывается│
   │ • Список каналов         │
   │ • Ссылки на каналы       │
   │ • Отметка "Отписался"    │
   └────────┬─────────────────┘
            │
            ▼

6. АРХИВИРОВАНИЕ
   ┌──────────────────────────┐
   │ Перенос в историю        │
   │ • giveaway_history       │
   │ • Сохранение результата  │
   │ • Обновление статистики  │
   └──────────────────────────┘
```

---

## 📊 СТРУКТУРА ДАННЫХ

```
USER
  │
  ├─ user_settings
  │   ├─ auto_detect: TRUE/FALSE
  │   ├─ min_confidence: 0.6 (60%)
  │   ├─ ai_enabled: TRUE/FALSE
  │   └─ export_format: "xlsx"
  │
  ├─ giveaways (АКТИВНЫЕ)
  │   ├─ id: 1
  │   ├─ title: "iPhone 15 Pro"
  │   ├─ prize: "iPhone 15 Pro Max"
  │   ├─ date_time: "2025-10-20 18:00"
  │   ├─ channels: "@tech_channel, @promo"
  │   ├─ status: "active"
  │   └─ created_at: "2025-10-05"
  │
  ├─ giveaway_channels (КАНАЛЫ)
  │   ├─ giveaway_id: 1
  │   ├─ channel_name: "@tech_channel"
  │   ├─ is_subscribed: TRUE
  │   └─ last_checked: "2025-10-06"
  │
  ├─ unsubscribe_tracking (ОТПИСКИ)
  │   ├─ giveaway_id: 1
  │   ├─ channel_name: "@tech_channel"
  │   ├─ unsubscribed_at: NULL
  │   └─ created_at: "2025-10-05"
  │
  ├─ giveaway_history (ИСТОРИЯ)
  │   ├─ original_giveaway_id: 1
  │   ├─ result: "Не выиграл"
  │   ├─ won: FALSE
  │   └─ completed_at: "2025-10-20"
  │
  └─ usage_stats (СТАТИСТИКА)
      ├─ action: "start"
      ├─ action: "auto_analysis"
      ├─ action: "add_giveaway"
      └─ timestamp: "..."
```

---

## 🔄 ПРОЦЕСС ПРОВЕРКИ ПОДПИСОК

```
ПОЛЬЗОВАТЕЛЬ: "✅ Проверить подписки"
        │
        ▼
┌─────────────────────────────────────┐
│ Показать список активных розыгрышей │
│ 1️⃣ iPhone 15 (3 канала)            │
│ 2️⃣ MacBook (2 канала)              │
└────────────┬────────────────────────┘
             │
  Пользователь выбирает №1
             │
             ▼
┌─────────────────────────────────────┐
│ Получить список каналов из БД       │
│ • @tech_channel                     │
│ • @promo_channel                    │
│ • @win_together                     │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ Для каждого канала:                 │
│                                     │
│ TRY:                                │
│   Telegram API → get_chat_member    │
│   Статус = member/admin?            │
│   ✅ ПОДПИСАН                       │
│                                     │
│ EXCEPT:                             │
│   ❌ НЕ ПОДПИСАН или ОШИБКА         │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ Отчёт пользователю:                 │
│                                     │
│ 🔍 Проверка подписок                │
│                                     │
│ @tech_channel: ✅                   │
│ @promo_channel: ❌ [Подписаться]   │
│ @win_together: ✅                   │
│                                     │
│ Результат: 2 из 3                   │
└─────────────────────────────────────┘
```

---

## 💡 СХЕМА ПРИНЯТИЯ РЕШЕНИЙ

```
                ПОЛУЧЕНО СООБЩЕНИЕ
                        │
                        ▼
              ┌─────────────────┐
              │ Это команда?    │
              │ (/start, кнопка)│
              └────┬─────┬──────┘
                   │     │
              ДА ◄─┘     └─► НЕТ
               │              │
               ▼              ▼
       ┌──────────────┐  ┌──────────────┐
       │ Обработать   │  │ Автопоиск    │
       │ команду      │  │ включён?     │
       └──────────────┘  └───┬─────┬────┘
                             │     │
                        ДА ◄─┘     └─► НЕТ
                         │              │
                         ▼              ▼
                  ┌─────────────┐  ┌────────────┐
                  │ Анализировать│  │ "Не понимаю│
                  │ на розыгрыш  │  │  команду"  │
                  └──────┬───────┘  └────────────┘
                         │
                         ▼
                  ┌─────────────┐
                  │ Уверенность │
                  │ >= порог?   │
                  └───┬─────┬───┘
                      │     │
                 ДА ◄─┘     └─► НЕТ
                  │              │
                  ▼              ▼
           ┌─────────────┐  ┌───────────┐
           │ Показать    │  │ Игнорировать│
           │ кнопки      │  │           │
           │ добавления  │  └───────────┘
           └─────────────┘
```

---

📖 **Подробнее:** [ИНСТРУКЦИЯ_ДЛЯ_ПОЛЬЗОВАТЕЛЯ.md](ИНСТРУКЦИЯ_ДЛЯ_ПОЛЬЗОВАТЕЛЯ.md)  
⚡ **Быстрый старт:** [БЫСТРЫЙ_СТАРТ.md](БЫСТРЫЙ_СТАРТ.md)







